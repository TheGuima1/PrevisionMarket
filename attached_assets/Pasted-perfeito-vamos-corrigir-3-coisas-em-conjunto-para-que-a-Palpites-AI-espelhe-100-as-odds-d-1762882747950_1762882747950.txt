perfeito — vamos corrigir **3 coisas** em conjunto para que a Palpites.AI **espelhe 100%** as odds da Polymarket na tela e o **spread (2%)** fique **como taxa separada** (sem alterar odds/payout exibidos). Abaixo vai um **PROMPT COMPLETÃO** para colar no Replit (ele já inclui mudanças de código e checagens).

---

# PROMPT PARA O REPLIT (colar como está)

**Objetivo:**

1. Odds **exibidas** = **exatamente** as da Polymarket (prob e decimal).
2. **Payout mostrado** = payout da Polymarket (sem embutir taxa).
3. **Taxa 2%** cobrada **separadamente** (linha “Taxa Palpites.AI”), **sem** alterar odds/payout exibidos.
4. Corrigir divergências de build/preview (mesmo dado em produção).

---

## 0) Ambiente e flags (prod & preview idênticos)

* Em **Secrets** do Replit, confira:

```
ENABLE_POLYMARKET=true
POLYMARKET_GAMMA_URL=https://gamma-api.polymarket.com
POLYMARKET_SLUGS=<seus slugs, separados por vírgula>
SPREAD_BPS=200
```

* Garanta que **o mesmo conjunto** de secrets é usado **no deploy** (produção).
* Desative qualquer cache do navegador antes de validar.
* Não deixe o seed recriar mercados em produção:

  * Em `server/routes.ts`, mantenha o auto-seed, mas ele já só roda se o banco estiver vazio — ok.

---

## 1) **Spread como taxa separada** (não mexe em odds/payout exibidos)

### 1.1 Altere a execução de compra para **não reduzir** o valor efetivo por spread

**Arquivo:** `server/amm-engine.ts`

> Substitua a função `buyShares` pela versão abaixo (ela **não** diminui `usdcIn` para o AMM; calcula e registra a taxa **separadamente**):

```ts
export function buyShares(
  usdcIn: number,
  outcome: 'yes' | 'no',
  currentState: AMMState,
  spreadBps: number = Number(process.env.SPREAD_BPS || 200)
): TradeResult {
  let { yesReserve, noReserve, k } = currentState;

  if (yesReserve < 0.01 || noReserve < 0.01 || k < 0.0001) {
    throw new Error("Market not initialized. Admin must seed liquidity first.");
  }

  // 1) Calcula taxa separada (2%), mas NÃO altera o capital que precifica shares
  const spreadFee = (usdcIn * spreadBps) / 10000;

  // 2) Cálculo de preço e shares SEM mexer no usdcIn (paridade com Polymarket)
  const currentPrice = outcome === 'yes'
    ? yesReserve / (yesReserve + noReserve)
    : noReserve / (yesReserve + noReserve);

  if (currentPrice < 0.001) {
    throw new Error("Price too low (< 0.1%). Market may need rebalancing.");
  }

  // Paridade: shares = stake / prob (igual Polymarket)
  const sharesBought = usdcIn / currentPrice;

  return {
    sharesBought,
    avgPrice: currentPrice,
    newYesReserve: yesReserve,  // não altera reservas no MVP
    newNoReserve: noReserve,
    newK: k,
    spreadFee,                  // taxa para registrar em TRANSACTIONS
  };
}
```

> Observação: sua **economia** agora é: o usuário paga R$100, vê odds idênticas às da Polymarket, recebe **as mesmas shares** que receberia lá; **adicionalmente**, cobramos e registramos **R$2** como “Taxa Palpites.AI”. (Simples e fiel ao que você pediu.)

### 1.2 Registre a taxa como transação/revenue (sem tocar no payout exibido)

**Arquivo:** `server/routes.ts` (no endpoint que cria a aposta; procure onde você executa `buyShares` e **após** ela, insira o registro da taxa)

```ts
// Depois de executar o buyShares(...)
const fee = result.spreadFee ?? 0;

// 1) Debita o total do usuário (stake + taxa já saiu do saldo pelo seu fluxo atual)
// 2) Registra a taxa como receita da plataforma (Transactions / "trade_buy" + "platform_fee")
// Se você já tem tabela/enum pra fee, use. Senão, registre como transaction separado:
await db.insert(transactions).values({
  userId: req.user!.id,
  type: 'trade_buy',                  // ou 'platform_fee' se preferir um tipo separado
  amount: fee.toFixed(6),
  currency: 'BRL',
  description: `Taxa Palpites.AI (${(Number(process.env.SPREAD_BPS||200)/100).toFixed(2)}%)`,
});
```

> Isso garante contabilidade da taxa, sem alterar odds/payout.

---

## 2) **Odds exibidas** = **Polymarket** (correção de arredondamento/deriva 30.77× vs 30.3×)

Problema visto: odds na UI (ex.: **30.77×**) não batem com a prob exibida (**3.3%**) — deveria ser ~**30.30×**. Isso costuma ocorrer quando a odd decimal é calculada a partir de um **valor arredondado** (% com 1 casa) ou quando outra função aplica clamp/spread invisível.

### 2.1 Sempre derive `decimal` **do prob cru** (sem arredondar antes)

**Arquivo:** `server/routes.ts` (rota `/api/polymarket/markets`)
Confirme que a `decimal` usa o **valor cru** do `probYes_display` (sem converter pra % antes). Deixe assim:

```ts
decimal: m.probYes_display > 0 ? Number((1 / m.probYes_display).toFixed(2)) : Infinity,
```

Mesma coisa para NO.

### 2.2 No **frontend**, use SEMPRE o `prob` cru para decimal

**Arquivo:** `client/src/components/market-card.tsx` (ou onde monta as odds na home)
Troque qualquer cálculo tipo `1 / (Number(formatProbability)/100)` por `1 / probRaw`.
Exemplo de bloco (mostrando prob + payout lado a lado):

```tsx
<div className="grid grid-cols-2 gap-2">
  <div>
    <div className="text-xs text-muted-foreground">SIM</div>
    <div className="flex items-baseline gap-1">
      <span className="text-xl font-bold tabular-nums text-primary">
        {formatProbability(yesPrice)} {/* yesPrice é o prob cru (0-1) */}
      </span>
      <span className="text-sm font-medium text-primary/80">
        ({formatOdds(1/yesPrice)}×)
      </span>
    </div>
  </div>
  <div>
    <div className="text-xs text-muted-foreground">NÃO</div>
    <div className="flex items-baseline gap-1">
      <span className="text-xl font-bold tabular-nums text-destructive">
        {formatProbability(noPrice)}
      </span>
      <span className="text-sm font-medium text-destructive/80">
        ({formatOdds(1/noPrice)}×)
      </span>
    </div>
  </div>
</div>
```

> **Importante:** `formatProbability(prob)` deve apenas formatar `%` na UI; **não** use esse `%` arredondado como base para `1/prob` — use o `prob` original (número 0–1).

---

## 3) **Payout exibido** = Polymarket (taxa mostrada à parte)

### 3.1 Ajuste o painel de aposta para exibir **payout bruto** (igual Polymarket) + **taxa**

**Arquivo:** `client/src/pages/market.tsx` (ou componente do TradePanel)

* Cálculos:

```ts
const stake = Number(stakeInput || 0);
const prob = selectedOutcome === 'yes' ? yesPrice : noPrice; // prob cru 0–1
const decimal = prob > 0 ? 1 / prob : Infinity;

const taxa = stake * (Number(import.meta.env.VITE_SPREAD_BPS ?? 200) / 10000); // 2%
const payoutBruto = stake * decimal; // IGUAL Polymarket (sem descontar taxa)
const payoutLiquido = (stake - taxa) * decimal; // opcional, mostrar como referência
```

* UI (exemplo):

```
Investimento:            R$ 100,00
Taxa Palpites.AI (2%):  R$ 2,00
--------------------------------
Odds (Polymarket):      30.30×
Probabilidade:          3.3%
Retorno bruto (se ganhar):  R$ 3.030,00   ← igual Polymarket
Retorno líquido (após taxa): R$ 2.969,40  ← opcional, só informativo
```

> Mantemos o “Retorno bruto (se ganhar)” como **paridade total** com Polymarket. A taxa é **transparente** em linha separada.

**Dica:** se quiser só “simplificar” e **não** mostrar “retorno líquido”, remova esta linha e exiba apenas a taxa destacada.

---

## 4) **Seeding e sincronização** (evitar 50/50 por engano)

* Em `server/seed.ts`, para mercados com `polymarketSlug`, inicialize reservas **a partir da probabilidade real** (já deixei um diff num prompt anterior).
* O **Mirror Worker** já sincroniza e congela odds (se houver spikes). Certifique-se de que ele roda no deploy (passo 0).

---

## 5) **Checklist de validação**

1. Home lista mercados com **prob (%)** e **odd (×)** consistentes: para 3.3% deve mostrar **30.30×**, não 30.77×.
2. Na tela do mercado, digite **100** e compare com Polymarket:

   * **Odds** e **Payout bruto** = **iguais** aos da Polymarket.
   * Linha **Taxa Palpites.AI (2%)** aparece separadamente.
3. Faça o mesmo teste para **NÃO**.
4. Publique e confira se **produção** mostra os **mesmos números** do preview (se não, revise secrets/flags).

---

## 6) Observações rápidas

* O problema de o seu payout estar **maior** que o da Polymarket vem de **(a)** decimal calculada a partir de `%` arredondado (ex.: 3.25% → 30.77×) e/ou **(b)** diferença de base de cálculo no painel. As mudanças acima eliminam isso.
* Com a taxa separada, a **odd exibida nunca muda** (paridade total). A Palpites.AI **lucra 2%** com transparência.

---

**Quer que eu gere os diffs completos (patch pronto) já aplicando estes trechos nos arquivos exatos do seu repo?**
